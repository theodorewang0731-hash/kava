#!/bin/bash

################################################################################
# KAVA 鑷姩鐩戞帶鑴氭湰 - 姣?30 绉掑埛鏂颁竴娆?################################################################################

# 棰滆壊
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m'

# 鍒锋柊闂撮殧锛堢锛?INTERVAL=30

echo -e "${CYAN}鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺?{NC}"
echo -e "${CYAN}  KAVA 璁粌鑷姩鐩戞帶锛堟瘡 ${INTERVAL} 绉掑埛鏂帮級${NC}"
echo -e "${CYAN}  鎸?Ctrl+C 閫€鍑?{NC}"
echo -e "${CYAN}鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺?{NC}"
echo ""

while true; do
    # 娓呭睆
    clear
    
    # 鏄剧ず鏃堕棿
    echo -e "${BLUE}鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺?{NC}"
    echo -e "${BLUE}  鏇存柊鏃堕棿: $(date '+%Y-%m-%d %H:%M:%S')${NC}"
    echo -e "${BLUE}鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺?{NC}"
    echo ""
    
    # =============================================================================
    # 1. SLURM 浠诲姟鐘舵€?    # =============================================================================
    echo -e "${YELLOW}[1/5] SLURM 浠诲姟鐘舵€?{NC}"
    echo "鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣"
    
    job_count=$(squeue -u $USER 2>/dev/null | grep -c "kava" || echo 0)
    
    if [ "$job_count" -gt 0 ]; then
        echo -e "${GREEN}鉁?鍙戠幇 ${job_count} 涓?KAVA 浠诲姟${NC}"
        echo ""
        squeue -u $USER --format="%.10i %.12j %.8T %.10M %.10l %.6D %.15R" | head -15
    else
        echo -e "${RED}鈿?褰撳墠鏃犺繍琛屼腑鐨勪换鍔?{NC}"
        echo "妫€鏌ユ渶杩戠殑浠诲姟鍘嗗彶..."
        echo ""
        sacct -u $USER -S today --format=JobID,JobName,State,Elapsed,End -n | grep kava | tail -5
    fi
    echo ""
    
    # =============================================================================
    # 2. 浠诲姟缁熻
    # =============================================================================
    echo -e "${YELLOW}[2/5] 浠诲姟缁熻${NC}"
    echo "鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣"
    
    if [ -f "outputs/job_ids.txt" ]; then
        total_main_jobs=$(wc -l < outputs/job_ids.txt)
        total_jobs=$((total_main_jobs * 3))  # 姣忎釜涓讳换鍔?3 涓瓙浠诲姟
        
        running=$(squeue -u $USER 2>/dev/null | grep -c " R " || echo 0)
        pending=$(squeue -u $USER 2>/dev/null | grep -c " PD " || echo 0)
        
        echo "鎻愪氦鐨勪换鍔? ${total_main_jobs} 涓富浠诲姟 (${total_jobs} 涓瓙浠诲姟)"
        echo "杩愯涓?(R):  ${running}"
        echo "绛夊緟涓?(PD): ${pending}"
        
        if [ "$running" -gt 0 ]; then
            progress=$((running * 100 / total_jobs))
            echo -e "杩涘害: ${GREEN}${progress}%${NC} (${running}/${total_jobs} 浠诲姟杩愯涓?"
        elif [ "$pending" -gt 0 ]; then
            echo -e "鐘舵€? ${YELLOW}绛夊緟璧勬簮鍒嗛厤${NC}"
        else
            echo -e "鐘舵€? ${CYAN}浠诲姟鍙兘宸插畬鎴愭垨澶辫触${NC}"
        fi
    else
        echo "鏈壘鍒颁换鍔¤褰曟枃浠?
    fi
    echo ""
    
    # =============================================================================
    # 3. 鏈€鏂版棩蹇椾俊鎭?    # =============================================================================
    echo -e "${YELLOW}[3/5] 鏈€鏂拌缁冩棩蹇?{NC}"
    echo "鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣"
    
    if [ -d "outputs/logs" ] && [ "$(ls -A outputs/logs/*.out 2>/dev/null)" ]; then
        latest_log=$(ls -t outputs/logs/*.out 2>/dev/null | head -1)
        if [ -n "$latest_log" ]; then
            echo "鏈€鏂版棩蹇? $(basename "$latest_log")"
            echo ""
            tail -5 "$latest_log" | sed 's/^/  /'
        else
            echo "鏆傛棤鏃ュ織鏂囦欢"
        fi
    else
        echo "鏆傛棤璁粌鏃ュ織锛堜换鍔″皻鏈紑濮嬶級"
    fi
    echo ""
    
    # =============================================================================
    # 4. GPU 鑺傜偣淇℃伅
    # =============================================================================
    echo -e "${YELLOW}[4/5] GPU 浣跨敤鎯呭喌${NC}"
    echo "鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣"
    
    if [ "$job_count" -gt 0 ]; then
        # 鑾峰彇杩愯鑺傜偣
        nodes=$(squeue -u $USER -o "%N" -h | grep -v "None assigned" | sort -u)
        if [ -n "$nodes" ]; then
            echo "杩愯鑺傜偣: $nodes"
        else
            echo "绛夊緟鑺傜偣鍒嗛厤..."
        fi
    else
        echo "鏃犳椿鍔ㄤ换鍔?
    fi
    echo ""
    
    # =============================================================================
    # 5. 棰勮瀹屾垚鏃堕棿
    # =============================================================================
    echo -e "${YELLOW}[5/5] 鏃堕棿浼扮畻${NC}"
    echo "鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣"
    
    if [ "$running" -gt 0 ]; then
        # 鑾峰彇鏈€鏃╁惎鍔ㄧ殑浠诲姟鏃堕棿
        oldest_start=$(sacct -u $USER -S today --format=JobID,Start,State -n | grep RUNNING | head -1 | awk '{print $2}')
        if [ -n "$oldest_start" ]; then
            echo "璁粌寮€濮? $oldest_start"
            echo "棰勮瀹屾垚: 36-48 灏忔椂鍚?
        fi
    elif [ "$pending" -gt 0 ]; then
        echo "浠诲姟鎺掗槦涓紝绛夊緟璧勬簮鍒嗛厤"
        echo "寮€濮嬪悗棰勮: 36-48 灏忔椂瀹屾垚"
    else
        echo "妫€鏌ヤ换鍔℃槸鍚﹀凡瀹屾垚鎴栧け璐?
    fi
    echo ""
    
    # =============================================================================
    # 蹇€熸搷浣滄彁绀?    # =============================================================================
    echo -e "${BLUE}鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺?{NC}"
    echo -e "${BLUE}  蹇€熸搷浣?{NC}"
    echo -e "${BLUE}鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺?{NC}"
    echo ""
    echo "鏌ョ湅璇︾粏鏃ュ織:  tail -f outputs/logs/kava_*.out"
    echo "鏌ョ湅閿欒鏃ュ織:  tail -f outputs/logs/kava_*.err"
    echo "鎵嬪姩妫€鏌ョ姸鎬?  squeue -u \$USER"
    echo "鍙栨秷鎵€鏈変换鍔?  scancel -u \$USER"
    echo ""
    echo -e "${CYAN}涓嬫鍒锋柊: ${INTERVAL} 绉掑悗...锛堟寜 Ctrl+C 閫€鍑猴級${NC}"
    
    # 绛夊緟
    sleep $INTERVAL
done
